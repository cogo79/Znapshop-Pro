<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Znapshop Pro</title>
		<script src="jquery.min.js">

		</script>
		<style>

			html, body {
				/* Standard */ height: calc(100% - 41px);
				/* Firefox */ height: -moz-calc(100% - 44px);
			}

			.toggleToolbar_ZP {
				position: absolute;
				/* Standard */margin-left: calc(100% - 150px);
				/* Firefox */margin-left: -moz-calc(100% - 150px);
				width:134px;
				height: 55px;
				top: 4px;
				top: -moz-calc(10px);
			}
			.canvasContainer_ZP {
				border: 1px solid black;
				background-color:lightgray;
				height: 100%;
				overflow: auto;
				float:left;
			}
			#canvas_ZP {
				border: 1px solid black;
				background-color: white;
				margin: 5px;
				cursor:crosshair;
			}
			.toolbar_ZP {
				width: 250px;
				height: 100%;
				/* Standard */height: calc(100% + 0px);
				/* Firefox */height: -moz-calc(100% + 0px);
				float:right;
				border:1px solid black;
				overflow: auto;
			}
			.toolbarHeader_ZP {
				font: 15px arial bold, sans-serif;
				margin-left: 10px;
				margin-bottom: 0px;
			}
			.toolbar_general_font_ZP {
				font: 12px arial, sans-serif;
				margin-left: 10px;
				margin-right: 10px;
				margin-bottom: 4px;
				height: 14px;
			}
			.toolbarSubHeader_ZP {
				font: 12px arial, sans-serif;
				margin-left: 20px;
				margin-top: 0px;
				margin-bottom: 0px;

			}
			.toolbarLine_ZP {
				border-bottom: 0px;
				color: black;
				margin-right: 4px;
				margin-left: 4px;
				margin-top: 0px;
				margin-bottom: 4px;
			}
			.input_ZP {
				margin-left: 30px;
				margin-right: 10px;
				margin-bottom: 8px;
				margin-top: 0px;
				width: 200px;
			}
			.toolbar_containter_ZP {
				margin-left: 10px;
				margin-right: 10px;
				margin-bottom: 4px;
				height: 18px;
			}
			.toolbar_button_containter_ZP {
				margin-left: 10px;
				margin-right: 10px;
				margin-bottom: 4px;
				margin-bottom: -moz-calc(6px);
				height: 18px;
			}
			.width_container_ZP {
				margin-left: 20px;
			}
			.toolbar_file_list_ZP {
				margin-top: 6px;
			}
			.toolbar_file_list_item_flag_ZP {
				position: relative;
				right:33px;
				color: grey;
			}
			.toolbar_file_list_item_name_ZP {
				position: relative;
				right: 13px;
			}
			.darknes_ZP {
				position: absolute; left:0px; top:0px; width:100%; height:100%;
				background-color: rgba(0,0,0,0.7);
			}
			.alertView_contianer_ZP {
				background-color: white; width: 280px; height: 180px; padding: 10px;
				position:absolute;
			    left:50%;
			    top:50%;
			    margin:-100px 0 0 -150px;
				border-radius: 10px;

			}

		</style>


		<script type="text/javascript">
			

		</script>
	</head>

	<body>
		<button class="toggleToolbar_ZP" type="button">Hide toolbar</button>
		<h1 class="header_ZP" style="margin-bottom: 10px;">Znapshop Pro</h1>
		<div class="canvasContainer_ZP">
			<div class="canvasWraper_ZP">
				<!--<canvas id="canvas_ZP" width="700" height="700"></canvas>-->
			</div>
		</div>
		<div class="toolbar_ZP">
			<h1 class="toolbarHeader_ZP">Tool settings</h1>
			<hr class="toolbarLine_ZP" noshade>
			<h1 class="toolbarSubHeader_ZP toolbar_general_font_ZP">Current tool:</h1>
			<select class="toolbarDropDownMenu_ZP input_ZP">
				<option value="pen">Pen</option>
				<option value="brush">Brush</option>
				<option value="line">Line</option>
			</select>
			<h1 class="toolbarSubHeader_ZP toolbar_general_font_ZP">Tool width: <span class="tool_width_shown_ZP"></span></h1>
			<input id="tool_width_input_ZP" class="input_ZP" type="range" min="1" max="100" value="5">
			<h1 class="toolbarSubHeader_ZP toolbar_general_font_ZP">Tool color:</h1>
			<input id="color_ZP" class="input_ZP" type="color">
			<hr class="toolbarLine_ZP" noshade>
			<div class="toolbar_button_containter_ZP">
				<button class="save_drawing_button_ZP" type="button">Save</button>
				<button class="new_drawing_button_ZP" type="button">New</button>
				<button class="delete_drawing_button_ZP" type="button">Delete</button>
			</div>
			<hr class="toolbarLine_ZP" noshade>
			<div class="toolbar_button_containter_ZP">
				<button class="undo_button_ZP" type="button">Undo</button>
				<button class="redo_button_ZP" type="button">Redo</button>
			</div>
			<hr class="toolbarLine_ZP" noshade>
			<div class="toolbar_general_font_ZP">
				Heigth: <span class="height_value_ZP"></span>px <span class="width_container_ZP">Width: <span class="width_value_ZP"></span>px</span>
			</div>
			<hr class="toolbarLine_ZP" noshade>
			<h1 class="toolbarHeader_ZP">Drawings</h1>
			<hr class="toolbarLine_ZP" noshade>
			<ul class="toolbar_file_list_ZP toolbar_general_font_ZP">
	  			
			</ul>
		</div>
		<div class="darknes_ZP" style="display: none;">
			<div class="alertView_contianer_ZP" style="display: none;">
				<div class="new_image_alertView_ZP" style="display: none;">
					New imgage<br>
					Name: <input id="drawing_name_input_ZP" type="text" name="height"><br>
					Height:
					<input id="drawing_height_input_ZP" type="text" pattern="[0-9]{10}" name="height">
					<br>
					Width:
					<input id="drawing_width_input_ZP" type="number" min="0" step="1" name="width">
					<br><br>
					<input type="button" value="OK" class="alertView_new_drawing_button_ZP">
					<input type="button" value="Cancel" class="alertView_cancel_ZP">
				</div>
			</div>
		</div>
	</body>

	<script type="text/javascript">
		var isFirefox = typeof InstallTrigger !== 'undefined';
		if (isFirefox) {
			console.log("Current browser is Firefox");
		}

		var DrawingLogBook = function(drawingId, width, height) {
			this.drawingId = drawingId;
			this.width = width; this.height = height;
			this.index = 0;
			this.logs = [];
		};
		var drawingLogBookArray = []; var currentLogBook;

		function sliceAndPush (imageObject) {
			var array;
			if (currentLogBook.index == currentLogBook.logs.length-1) {
				currentLogBook.logs.push(imageObject);
				array = currentLogBook.logs;
			} else {
				console.log("slice");
				var tempArray = currentLogBook.logs.slice(0, currentLogBook.index+1);
				tempArray.push(imageObject);
				array = tempArray;
			}
			if (array.length > 1) {
				currentLogBook.index++;
			}
			return array;
		};
		function logDrawing() { 
			console.log("logDrawing");
			if (isFirefox) {
				var image = new Image();
				image.src = document.getElementById('canvas_ZP').toDataURL();
				currentLogBook.logs = sliceAndPush(image);
				console.log("sliceAndPush() this.logs.length: " + currentLogBook.logs.length + "   this.index: " + currentLogBook.index);
			} else {
				var imageData = document.getElementById('canvas_ZP').toDataURL();
				currentLogBook.logs = sliceAndPush(imageData);
				console.log("sliceAndPush() this.logs.length: " + currentLogBook.logs.length + "   this.index: " + currentLogBook.index);
			}
			
		};

		function undo() {
			//console.log("undo() this.index: " + this.index);
			if (isFirefox) {

				ctx.clearRect(0, 0, currentLogBook.width, currentLogBook.height);
				if (currentLogBook.index > 0) {
					currentLogBook.index--;
					var image = currentLogBook.logs[currentLogBook.index];
					ctx.drawImage(image, 0, 0);
				}

			} else {
				ctx.clearRect(0, 0, currentLogBook.width, currentLogBook.height);
				if (currentLogBook.index > 0) {
					currentLogBook.index--;
					var image = new Image();
					image.src = currentLogBook.logs[currentLogBook.index];
					ctx.drawImage(image, 0, 0);
				}
			}
			
			console.log("after undo() this.logs.length: " + currentLogBook.logs.length + "   this.index: " + currentLogBook.index);
		};
		function redo() {
			if (isFirefox) {
					if (currentLogBook.index < currentLogBook.logs.length-1) {
					ctx.clearRect(0, 0, currentLogBook.width, currentLogBook.height);
					currentLogBook.index++;
					var image = currentLogBook.logs[currentLogBook.index];
					ctx.drawImage(image,0,0);
					console.log("redo() this.logs.length: " + currentLogBook.logs.length + "    this.index: " + currentLogBook.index);
				}
			} else {
				if (currentLogBook.index < currentLogBook.logs.length-1) {
					ctx.clearRect(0, 0, currentLogBook.width, currentLogBook.height);
					currentLogBook.index++;
					var image = new Image();
					image.src = currentLogBook.logs[currentLogBook.index];
					ctx.drawImage(image,0,0);
					console.log("redo() this.logs.length: " + currentLogBook.logs.length + "    this.index: " + currentLogBook.index);
				}
			}
		};

		var addFileListItem = function(fileName, id) {
			//'<li><span class="toolbar_file_list_item_flag_ZP">ns</span><span class="toolbar_file_list_item_name_ZP">Coffee</span></li>'
			
		};

		var resize = function(){
			var left = function() {
				if( $('.canvasWraper_ZP').outerWidth() > $('.canvasContainer_ZP').width() ) {
					return 0;
				} else {
					return ($('.canvasContainer_ZP').width() - $('.canvasWraper_ZP').outerWidth()) / 2;
				}
			};
			var top = function() {
				if( $('.canvasWraper_ZP').outerHeight() > $('.canvasContainer_ZP').height() ) {
					return 0;
				} else {
					return ($('.canvasContainer_ZP').height() - $('.canvasWraper_ZP').outerHeight()) / 2;
				}
			};
			$('.canvasWraper_ZP').css({
				position:'relative',
				left: left(),
				top: top()
			});
		};
		var newDrawing = function(width, height, name) {
			var margin = 20;
			var canvas = '<canvas id="canvas_ZP" width="' + width + '" height="' + height + '"></canvas>';
			$('.canvasWraper_ZP').html(canvas);
			$('#canvas_ZP').css({margin: (margin/2) - 1 });
			$('.canvasWraper_ZP').css({height: height+margin, width:width+margin});
			$('.height_value_ZP').html(height); $('.width_value_ZP').html(width);
			var getNewUniqueClientSessionIDForDrawing = (function () {
	      		var c = 0;
	      		return function () {
	      			return "d" + ++c;
	      		}
	    	})();
			var id = getNewUniqueClientSessionIDForDrawing();
			if (!name) {
				name = "untitled";
			}
			var listItem = '<li id="' + id + '"><span class="toolbar_file_list_item_flag_ZP">ns</span><span class="toolbar_file_list_item_name_ZP">' + name + '</span></li>';
			$('.toolbar_file_list_ZP').append(listItem);
			
			
			$(window).trigger('resize');
			currentLogBook = null;
			currentLogBook = new DrawingLogBook(id, $('#canvas_ZP').width(), $('#canvas_ZP').height());
			logDrawing();
			drawingLogBookArray.push(currentLogBook);
			prepareCanvas();
		};
		newDrawing(200,100,"untitled");
		$(window).resize(resize);

		var toolbarHidden = false;
		var hideToolbar = function() {
			$('.toolbar_ZP').hide();
			$('.canvasContainer_ZP').css('width', 'calc(100% - 2px)');
			$('.canvasContainer_ZP').css('width', '-moz-calc(100% - 2px)');
			toolbarHidden = true;
			$('.toggleToolbar_ZP').html("Show toolbar");
			$(window).resize();
		};
		var showToolbar = function() {
			$('.toolbar_ZP').show();
			$('.canvasContainer_ZP').css('width', 'calc(100% - 257px)');
			$('.canvasContainer_ZP').css('width', '-moz-calc(100% - 257px)');
			toolbarHidden = false;
			$('.toggleToolbar_ZP').html("Hide toolbar");
			$(window).resize();
		};
		$('.toggleToolbar_ZP').click(function() {
			if (toolbarHidden) {
				showToolbar();
			} else {
				hideToolbar();
			}
		});
		showToolbar();

		$('.tool_width_input_ZP').on("change mousemove", function() {
			console.log("change: ???");
			//$('.tool_width_shown_ZP').html($('.tool_width_input_ZP').val());
		});
		
		function getMousePos(canvas, evt) {
		    var rect = canvas.getBoundingClientRect();
		    return {
		        x: evt.clientX - rect.left,
		        y: evt.clientY - rect.top
		    };
		}
		
		var ctx;
		function prepareCanvas() {
			ctx = document.getElementById('canvas_ZP').getContext("2d");

			$('#canvas_ZP').mousedown(function(e){
				console.log("mousedown");
				var pos = getMousePos(document.getElementById("canvas_ZP"), e);
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("pen") == 0) {
					penMouseDown(pos, $('#color_ZP').val(), $('#tool_width_input_ZP').val());
				}
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("brush") == 0) {
					brushMouseDown(pos, $('#color_ZP').val(), $('#tool_width_input_ZP').val());
				}
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("line") == 0) {
					lineMouseDown(pos, $('#color_ZP').val(), $('#tool_width_input_ZP').val());
				}
			});
			$('#canvas_ZP').mousemove(function(e){
				var pos = getMousePos(document.getElementById("canvas_ZP"), e);
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("pen") == 0) {
					penMouseMove(pos);
				}
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("brush") == 0) {
					brushMouseMove(pos);
				}
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("line") == 0) {
					lineMouseMove(pos);
				}
			});

			$('#canvas_ZP').mouseup(function(e){
				var pos = getMousePos(document.getElementById("canvas_ZP"), e);
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("pen") == 0) {
					penMouseUp(pos);
				}
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("brush") == 0) {
					brushMouseUp(pos);
				}
				if ($('.toolbarDropDownMenu_ZP').val().localeCompare("line") == 0) {
					lineMouseUp(pos);
				}
				logDrawing();
			});
			
			$(function(){
				$(window).mouseout(function(e){
					if ($('.toolbarDropDownMenu_ZP').val().localeCompare("pen") == 0) {
						penMouseUp(getMousePos(document.getElementById("canvas_ZP"), e));
					}
					if ($('.toolbarDropDownMenu_ZP').val().localeCompare("brush") == 0) {
						brushMouseUp(getMousePos(document.getElementById("canvas_ZP"), e));
					}
				});
			});
		}
		
		$('.undo_button_ZP').click(function() {
			undo();
		});

		$('.redo_button_ZP').click(function() {
			redo();
		});

		var previosPos;
		
		var circleRadius;
		var drawCircle = function(pos) {
			ctx.beginPath();
			ctx.arc(pos.x, pos.y, circleRadius, 0, 2 * Math.PI, true);
			ctx.fill();
		};
		var drawLine = function(from, to) {
			ctx.beginPath();
			ctx.moveTo(from.x, from.y);
			ctx.lineTo(to.x, to.y);
			ctx.stroke();
		};

		var drawing = false;
		var penMouseDown = function(pos,strokeStyle, lineWidth) {
			circleRadius = lineWidth/2;
			drawing = true;
			ctx.fillStyle = strokeStyle;
			drawCircle(pos);
			previosPos = pos;

			ctx.strokeStyle = strokeStyle;
			ctx.lineWidth = lineWidth;
		};
		var penMouseMove = function(to) {
			if (drawing) {
				drawLine(previosPos, to)
				drawCircle(to);
				previosPos = to;
			}
		};
		var penMouseUp = function(pos) {
			if (drawing) {
				drawLine(previosPos, pos)
				drawCircle(pos);
				drawing = false;

			}
		};
		var brushMouseDown = function(pos, strokeStyle, lineWidth) {
			circleRadius = lineWidth/2;
			drawing = true;

			ctx.fillStyle = strokeStyle;
			drawCircle(pos);
		};
		var brushMouseMove = function(pos) {
			if (drawing) {
				drawCircle(pos);
			}
		};
		var brushMouseUp = function(pos) {
			if (drawing) {
				drawCircle(pos);
				drawing = false;
			}
		};
		
		var lineToolSettings = {
			startPos : {},
			imageObject : null
		};
		var lineMouseDown = function(pos, strokeStyle, lineWidth) {
			//var c = document.createElement("CANVAS").getContext("2d");
			//imageData = c.getImageData(0, 0, $('#canvas_ZP').width(), $('#canvas_ZP').height());
			var imageData = document.getElementById('canvas_ZP').toDataURL();
			var imageObject = new Image();
			imageObject.src = imageData;
			lineToolSettings.imageObject = imageObject;
			lineToolSettings.startPos = pos;
			drawing = true;

			ctx.strokeStyle = strokeStyle;
			ctx.lineWidth = lineWidth;
		};
		var lineMouseMove = function(pos) {
			if (drawing) {
				ctx.clearRect(0, 0, $('#canvas_ZP').width(), $('#canvas_ZP').height());
				ctx.drawImage(lineToolSettings.imageObject,0,0);
				drawLine(lineToolSettings.startPos, pos);
			}
		};
		var lineMouseUp = function(pos) {
			if (drawing) {
				lineMouseMove(pos);
				drawing = false;
			}
		};

		$('.new_drawing_button_ZP').click(function() {
			showNewImageAlertView();
		});

		$('.alertView_new_drawing_button_ZP').click(function() {
			console.log("New button");
		});
		$('.alertView_cancel_ZP').click(function() {
			close_alert();
		});
		$('.alertView_new_drawing_button_ZP').click(function() {
			var width = Number($('#drawing_width_input_ZP').val());
			var height = Number($('#drawing_height_input_ZP').val());
			var name = $('#drawing_name_input_ZP').val();
			newDrawing(width,height,name);
			close_alert();
		});

		var showNewImageAlertView = function() {
			$('.darknes_ZP').show();
			$('.alertView_contianer_ZP').show();
			$('.new_image_alertView_ZP').show();
		};
		var close_alert = function() {
			$('.darknes_ZP').hide();
			$('.alertView_contianer_ZP').hide();
			$('.new_image_alertView_ZP').hide();
		};


	</script>

</html>